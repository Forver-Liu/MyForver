{% extends 'base.html' %}

{% block css %}
	<title>index</title>
	<style>
		.part4{
			background-color:#f6f6f6;
		}
		.hide{
			display:none;
		}
	</style>
{% endblock %}


{% block body %}

{% for item in data %}
	<div class='item' style="margin-top:15px;">
		<div class="part1">
			<a href='/detail/{{item.url}}'>{{item.title}}</a>
			<span>---{{item.news_type.display}}</span>
		</div>
		<div class='part2'>
			{{item.summary}}
		</div>
		<div class='part3'>
			<a href='' onclick='Favor(this,{{item.id}});'>赞{{item.favor_count}}</a>
			<a href='' class="reply_count" onclick='Reply(this,{{item.id}});'>评论{{item.reply_count}}</a>
			<span>{{item.create_date|date:"Y-m-d H:i:s"}}</span>
		</div>
		<div class='part4 hide' >
			<div class="replys">历史评论
			
			</div>
			<div class="inputs">
				<label>输入评论内容：</label><textarea></textarea>
				<input type="button" value='提交' onclick="submitreply(this,{{item.id}});"/>
			</div>
		</div>
	</div>
{% endfor %}

{% endblock %}


{% block js %}
	<script type="text/javascript">
		function Favor(doc,id){
			$.ajax({
				url:"/process1/addfavor/",
				data:{nid:id},
				type:"POST",
				success:function(callback){
					var obj = jQuery.parseJSON(callback);
					if(obj.stat == 0){
						console.log(obj.stat)
						console.log(obj.data)
						var tmp = '赞(' + obj.data +')';
						$(doc).text(tmp);						
					}else{
						alert(obj.message);
					}
				}		
			});
			
		};
		
		function Reply(doc,id){
			//$(doc).removeClass('hide');
			$(doc).parent().next().toggleClass('hide');	
			/*
			if($(doc).attr('has-input') == 0){
				$(doc).append("<label>输入评论内容：</label><textarea></textarea>");
				$(doc).attr('has-input',1);
			}*/
			
			$.ajax({
				url:"/process1/getreply/",
				data:{nid:id},
				type:"POST",
				success:function(callback){
					var obj = jQuery.parseJSON(callback);
					$(doc).parent().next().find(".replys").rmpty();
					$.each(obj,function(k,v){
					var tmp = "<div>"+v.user__username+":"+v.fields.content+"---"+v.create_time+"</div>";
						
						$(doc).parent().next().find(".replys").append(tmp);
					})
				}
			});
			
		};
		
		function submitreply(doc,id){
			var val = $(doc).prev().val();
			$(doc).prev().val('');
			$.ajax({
				url:'/process1/submitreply/',
				data:{nid:id,data:val},
				type:"POST",
				success:function(callback){
					console.log(callback);
					callback = jQuery.parseJSON(callback);
					if(callback.stat == 1){
						alert('callback.message');
					}else{
						var tmp = "<div>"+callback.data.user__username+":"+callback.data.fields.content+"---"+callback.data.create_time+"</div>";
						$(doc).parent().prev().append(tmp);
						count = "评论（" + callback.reply_count + ")";
						$(doc).parent().parent().prev().find('.reply_count').text(count);
					}
				}
			});
		};
	</script>
{% endblock %}